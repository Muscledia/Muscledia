name: Deploy to OCI

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types:
      - completed
    branches: [ main ]
  workflow_dispatch:
    inputs:
      skip_health_check:
        description: 'Skip health check after deployment'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.OCI_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.OCI_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment directory on server
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            mkdir -p ~/muscledia
            mkdir -p ~/muscledia/config
            echo "Deployment directory ready"
          EOF

      - name: Backup existing configuration
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            cd ~/muscledia
            if [ -f docker-compose.yml ]; then
              echo "Backing up existing docker-compose.yml..."
              cp docker-compose.yml docker-compose.yml.bak
            fi
          EOF

      - name: Upload docker-compose configuration
        run: |
          scp -i ~/.ssh/id_rsa \
            docker-compose.prod.yml \
            ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }}:~/muscledia/docker-compose.yml
          echo "Docker compose configuration uploaded"

      - name: Upload configuration files
        run: |
          if [ -d "config" ]; then
            scp -i ~/.ssh/id_rsa -r \
              config/* \
              ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }}:~/muscledia/config/ || echo "No config files to upload"
          else
            echo "No config directory found, skipping"
          fi

      - name: Pull latest images
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            cd ~/muscledia
            echo "=========================================="
            echo "Pulling latest Docker images..."
            echo "=========================================="
            docker-compose pull
            echo "Images pulled successfully"
          EOF

      # REMOVED: "Stop old containers" and "Clean up old resources" steps
      # to ensure old containers keep running if new ones fail to start.

      - name: Start services
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            cd ~/muscledia
            echo "=========================================="
            echo "Starting services..."
            echo "=========================================="
            # docker-compose up -d will automatically recreate changed containers
            # and leave unchanged ones running.
            docker-compose up -d
            echo "Services started"
          EOF

      - name: Wait for services to initialize
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            echo "=========================================="
            echo "Waiting 120 seconds for services to initialize..."
            echo "=========================================="
            sleep 120
            echo "Initialization period complete"
          EOF

      - name: Check service status
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            cd ~/muscledia
            echo "=========================================="
            echo "Service Status:"
            echo "=========================================="
            docker-compose ps
          EOF

      - name: Health check
        if: ${{ !inputs.skip_health_check }}
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            echo "=========================================="
            echo "Running health checks..."
            echo "=========================================="
          
            # Function to check health
            check_health() {
              local service=$1
              local port=$2
              local max_attempts=15
              local attempt=1
          
              while [ $attempt -le $max_attempts ]; do
                # Use -v to see headers if it fails, or check status code
                if curl -s -f -o /dev/null http://localhost:$port/actuator/health; then
                  echo "✓ $service is healthy"
                  return 0
                else
                  echo "Attempt $attempt/$max_attempts: $service not ready yet..."
                  sleep 10 
                  attempt=$((attempt + 1))
                fi
              done
          
              echo "✗ $service health check failed after $max_attempts attempts"
              # Print logs on failure to help debug
              if [ "$service" == "AI Service" ]; then
                  echo "--- AI Service Logs ---"
                  docker logs muscledia-ai-service --tail 50
                  echo "-----------------------"
              fi
              return 1
            }
          
            # Check all services
            failed=0
          
            check_health "Service Discovery" 8761 || failed=1
            sleep 5
          
            check_health "User Service" 8081 || failed=1
            check_health "Workout Service" 8082 || failed=1
            check_health "Gamification Service" 8083 || failed=1
            check_health "AI Service" 8084 || failed=1
            check_health "API Gateway" 8080 || failed=1
          
            if [ $failed -eq 1 ]; then
              echo "=========================================="
              echo "Some services failed health checks!"
              echo "=========================================="
              exit 1
            fi
          
            echo "=========================================="
            echo "All services are healthy!"
            echo "=========================================="
          EOF

      - name: Clean up old images (Post-Success)
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            echo "=========================================="
            echo "Deployment successful. Cleaning up old resources..."
            echo "=========================================="
            # Prune only dangling images/containers to save space, now that new ones are healthy
            docker image prune -f
            echo "Cleanup complete"
          EOF

      - name: Display deployment summary
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            cd ~/muscledia
            echo "=========================================="
            echo "Deployment Summary"
            echo "=========================================="
            echo ""
            echo "Running Containers:"
            docker-compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"
            echo ""
            echo "Resource Usage:"
            docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"
            echo ""
            echo "=========================================="
            echo "Deployment completed successfully!"
            echo "=========================================="
            echo "Access your services at:"
            echo "  - API Gateway: http://89.168.117.65:8080"
            echo "  - Eureka Dashboard: http://89.168.117.65:8761"
            echo "=========================================="
          EOF

      - name: Rollback on failure
        if: failure()
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            cd ~/muscledia
            echo "=========================================="
            echo "DEPLOYMENT FAILED - INITIATING ROLLBACK"
            echo "=========================================="
          
            # 1. Collect logs
            echo "Collecting logs for debugging..."
            docker-compose logs --tail=50
          
            # 2. Restore previous configuration
            if [ -f docker-compose.yml.bak ]; then
                echo "Restoring previous docker-compose.yml..."
                mv docker-compose.yml.bak docker-compose.yml
          
                echo "Redeploying previous stable version..."
                docker-compose up -d
          
                echo "Rollback command executed. Check server status manually."
            else
                echo "No backup configuration found. Stopping failed containers."
                docker-compose down
            fi
          
            echo "=========================================="
            echo "Rollback procedure complete"
            echo "=========================================="
          EOF