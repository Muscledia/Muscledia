name: Deploy to OCI

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types:
      - completed
    branches: [ main ]
  workflow_dispatch:
    inputs:
      skip_health_check:
        description: 'Skip health check after deployment'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.OCI_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.OCI_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment directory on server
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            mkdir -p ~/muscledia
            mkdir -p ~/muscledia/config
            echo "Deployment directory ready"
          EOF

      - name: Upload docker-compose configuration
        run: |
          scp -i ~/.ssh/id_rsa \
            docker-compose.prod.yml \
            ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }}:~/muscledia/docker-compose.yml
          echo "Docker compose configuration uploaded"

      - name: Upload configuration files
        run: |
          if [ -d "config" ]; then
            scp -i ~/.ssh/id_rsa -r \
              config/* \
              ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }}:~/muscledia/config/ || echo "No config files to upload"
          else
            echo "No config directory found, skipping"
          fi

      - name: Pull latest images
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            cd ~/muscledia
            echo "=========================================="
            echo "Pulling latest Docker images..."
            echo "=========================================="
            docker-compose pull
            echo "Images pulled successfully"
          EOF

      - name: Stop old containers
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            cd ~/muscledia
            echo "=========================================="
            echo "Stopping old containers..."
            echo "=========================================="
            docker-compose down --timeout 30
            echo "Old containers stopped"
          EOF

      - name: Clean up old resources
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            echo "=========================================="
            echo "Cleaning up resources..."
            echo "=========================================="
            docker container prune -f
            docker image prune -f
            echo "Cleanup complete"
          EOF

      - name: Start services
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            cd ~/muscledia
            echo "=========================================="
            echo "Starting services..."
            echo "=========================================="
            docker-compose up -d
            echo "Services started"
          EOF

      - name: Wait for services to initialize
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            echo "=========================================="
            echo "Waiting 60 seconds for services to initialize..."
            echo "=========================================="
            sleep 60
            echo "Initialization period complete"
          EOF

      - name: Check service status
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            cd ~/muscledia
            echo "=========================================="
            echo "Service Status:"
            echo "=========================================="
            docker-compose ps
          EOF

      - name: Health check
        if: ${{ !inputs.skip_health_check }}
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            echo "=========================================="
            echo "Running health checks..."
            echo "=========================================="
          
            # Function to check health
            check_health() {
              local service=$1
              local port=$2
              local max_attempts=10
              local attempt=1
          
              while [ $attempt -le $max_attempts ]; do
                if curl -sf http://localhost:$port/actuator/health > /dev/null 2>&1; then
                  echo "✓ $service is healthy"
                  return 0
                else
                  echo "Attempt $attempt/$max_attempts: $service not ready yet..."
                  sleep 5
                  attempt=$((attempt + 1))
                fi
              done
          
              echo "✗ $service health check failed after $max_attempts attempts"
              return 1
            }
          
            # Check all services
            failed=0
          
            check_health "Service Discovery" 8761 || failed=1
            sleep 10
          
            check_health "User Service" 8081 || failed=1
            check_health "Workout Service" 8082 || failed=1
            check_health "Gamification Service" 8083 || failed=1
            check_health "AI Service" 8084 || failed=1
            check_health "API Gateway" 8080 || failed=1
          
            if [ $failed -eq 1 ]; then
              echo "=========================================="
              echo "Some services failed health checks!"
              echo "=========================================="
              exit 1
            fi
          
            echo "=========================================="
            echo "All services are healthy!"
            echo "=========================================="
          EOF

      - name: Display deployment summary
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            cd ~/muscledia
            echo "=========================================="
            echo "Deployment Summary"
            echo "=========================================="
            echo ""
            echo "Running Containers:"
            docker-compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"
            echo ""
            echo "Resource Usage:"
            docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"
            echo ""
            echo "=========================================="
            echo "Deployment completed successfully!"
            echo "=========================================="
            echo "Access your services at:"
            echo "  - API Gateway: http://89.168.117.65:8080"
            echo "  - Eureka Dashboard: http://89.168.117.65:8761"
            echo "=========================================="
          EOF

      - name: Rollback on failure
        if: failure()
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.OCI_USER }}@${{ secrets.OCI_HOST }} << 'EOF'
            cd ~/muscledia
            echo "=========================================="
            echo "Deployment failed - collecting logs..."
            echo "=========================================="
            echo ""
            echo "Last 50 lines of logs:"
            docker-compose logs --tail=50
          
            echo ""
            echo "=========================================="
            echo "Stopping failed deployment..."
            echo "=========================================="
            docker-compose down
          
            echo ""
            echo "=========================================="
            echo "Rollback Instructions:"
            echo "=========================================="
            echo "1. Check the logs above for errors"
            echo "2. Fix the issues in your code"
            echo "3. Push a new commit to trigger redeployment"
            echo "4. Or manually deploy with: cd ~/muscledia && docker-compose up -d"
            echo "=========================================="
          EOF